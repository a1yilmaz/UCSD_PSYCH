<html>
<meta charset="utf-8">

<head>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-firestore.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet">
	<link rel="stylesheet" href="css/styles.css" type="text/css" />
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
	<style>
		img {
			width:100%;
		}

		#not-selected{
			font-size: 25px;
			color: red;
		}

		#selected{
			font-size: 15px;
			color: black;
		}

		p span{
			color: #64f24f;
			font-size: 30px;
		}
	</style>
</head>

<body>
	<div class="container">
		<div class="row">
			<h5>Please rate how confident you are that the woman below is the woman in the video </h5>
			</br>
			<h5> 0% - I guessed, 100% absolutely certain</h5>
		</div>
		<!-- Row 1, Col 1. -->
		<div class="row justify-content-between">
			<div class="col-md-4">
				<img id='0' src='media/fillers/blank.png'>
				<div class="slidecontainer">
					<input type="range" min="0" max="100" value="50" class="slider" id="slider0" hidden>
					<p id="not-selected" hidden>Value: <span id="slider0-output"></span></p>
				</div>
			</div>
			<!-- Row 1, Col 2 -->
			<div class="col-md-4">
				<img id='1' src='media/fillers/blank.png'>
				<div class="slidecontainer">
					<input type="range" min="0" max="100" value="50" class="slider" id="slider1" hidden>
					<p id="not-selected" hidden>Value: <span id="slider1-output"></span></p>
				</div>
			</div>
			<!-- Row 1, Col 3 -->
			<div class="col-md-4">
				<img id='2' src='media/fillers/blank.png'>
				<div class="slidecontainer">
					<input type="range" min="0" max="100" value="50" class="slider" id="slider2" hidden>
					<p id="not-selected" hidden>Value: <span id="slider2-output"></span></p>
				</div>
			</div>
		</div>
		</br>
		<!-- Row 2, Col 1 -->
		<div class="row justify-content-between">
			<div class="col-md-4">
				<img id='3' src='media/fillers/blank.png'>
				<div class="slidecontainer">
					<input type="range" min="0" max="100" value="50" class="slider" id="slider3" hidden>
					<p id="not-selected" hidden>Value: <span id="slider3-output"></span></p>
				</div>
			</div>
			<!-- Row 2, Col 2 -->
			<div class="col-md-4">
				<img id='4' src='media/fillers/blank.png'>
				<div class="slidecontainer">
					<input type="range" min="0" max="100" value="50" class="slider" id="slider4" hidden>
					<p id="not-selected" hidden>Value: <span id="slider4-output"></span></p>
				</div>
			</div>

			<!-- Row 2, Col 3 -->
			<div class="col-md-4">
				<img id='5' src='media/fillers/blank.png'>
				<div class="slidecontainer">
					<input type="range" min="0" max="100" value="50" class="slider" id="slider5" hidden>
					<p id="not-selected" hidden>Value: <span id="slider5-output"></span></p>
				</div>
			</div>
		</div>
		<div class="row" id="standard" hidden>
			<div class="form-check mt-3">
				<input id="notPresentCheck" class="form-check-input" type="checkbox" onclick="radioClicked()" style="width:20px; height: 20px; border-radius: 4px; background-color: lightgrey; margin-top: 11px; " />
				<label class="form-check-label mt-1" style="font-size: 1.25rem; margin-top: 0.4rem">Check here <strong>if the person is not present</strong></label>
			</div>

		</div>
		<div  class="row" id="confidence-slider" hidden>
			<div class="form-check mt-3">
				<h5>How certain are you?</h5>
				<input type="range" min="0" max="100" value="50" class="slider" id="slider6" oninput="changeSlider(this)">
				<p id="not-selected">Value: <span id="slider6-output"></span></p>
			</div>
		</div>

		<div class="row">
			<input id="Next" onClick="submit()" class="btn btn-primary" type="submit" name="formSubmit" value="Next" hidden />
		</div>
	</div>

	<script type="text/javascript">
		firebase.initializeApp({
			apiKey: "AIzaSyCa5_e0vkkiBXQxKcpvGKHyumnWyvQ_os8",
			authDomain: "ucsd-psych.firebaseapp.com",
			databaseURL: "https://ucsd-psych.firebaseio.com",
			projectId: "ucsd-psych",
			storageBucket: "ucsd-psych.appspot.com",
			messagingSenderId: "325328536445"
		});

		// when body renders
		document.getElementsByTagName("body")[0].onload = function() {
			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
					window.userId = user.uid;
					firebase.database().ref("slider/" + window.userId + "/experiment type")
						.once('value').then(function(snapshot) {
							window.experimentType = snapshot.val();

							initializeExperiment(window.experimentType);
						});
				} else {
					window.location = '/debrief'
				}
			});
		}

		// initialize DOM based on exp type
		function initializeExperiment(expType){
			let lineup = getPics(window.experimentType);
			addPics(lineup);

			// check if standard exp
			switch(expType.includes("s")){
				case true:
					makePicturesSelectable();
					showNonePresentButton();
					break;
				case false:
					showSliders();
					break;
			}
		}

		// will change code to allow pictures to be selected for standard lineup
		function makePicturesSelectable(){
			let pictures = document.getElementsByTagName("img");
			for(let picture in pictures){
				let curr_pic = pictures[picture];
				curr_pic.onclick = function(){
					selectedPicture(this);
				}
			}
		}

		function showNonePresentButton(){
			document.getElementById("standard").hidden = false;
		}

		let selectedImg;
		// handles putting border around image and  keeping track of which image is
		// selected and clearing other borders
		function selectedPicture(imgElement){
			clearSelectedPictures();
			unselectBox();
			imgElement.style["border"] = "5px solid red";
			selectedImg = imgElement.id;
			showConfidenceSlider();
		}

		function unselectBox(){
			document.getElementById("notPresentCheck").checked = false;
		}

		function clearSelectedPictures(){
			let pictures = document.getElementsByTagName("img");
			for(let picture in pictures){
				let curr_pic = pictures[picture];
				if(curr_pic.style){
					curr_pic.style.border = "";
				}
			}
		}

		// will change sliders and values to be visible and will also add logic to sliders
		function showSliders(){
			/* code for slider logic */
			let sliders = document.getElementsByClassName("slider")
			for (var slider in sliders) {
				let curr_slider = sliders[slider];
				// show slider
				curr_slider.hidden = false;
				let curr_output = document.getElementById(curr_slider.id + "-output");
				if(curr_output){
					curr_output.parentNode.hidden = false;
				}
				sliders[slider].oninput = function() {
					curr_output.innerHTML = this.value + "%";
					curr_output.parentNode.id = "selected";
					inputted(this);
				}
			}
		}

		function changeSlider(element){
			let curr_output = document.getElementById('slider6-output');
			curr_output.innerHTML = element.value + "%";
			curr_output.parentNode.id = "selected";
			document.getElementById("Next").hidden = false;
		}

		// logic for checking if all 6 slider inputs have been inputted
		let inputs = {};
		function inputted(element) {
			if (!(element.id in inputs)) {
				inputs[element.id] = true;
			}
			if (Object.keys(inputs).length == 6) {
				//show next button
				document.getElementById("Next").hidden = false;
			}
		}

		// logic for when radio button is clicked
		function radioClicked(){
			clearSelectedPictures();
			showConfidenceSlider();
		}

		function showConfidenceSlider(){
			document.getElementById("confidence-slider").hidden = false;
		}

		// used to shuffle array of mugshot pics
		function shuffle(array) {
			var currentIndex = array.length,
				temporaryValue, randomIndex;

			// While there remain elements to shuffle...
			while (0 !== currentIndex) {

				// Pick a remaining element...
				randomIndex = Math.floor(Math.random() * currentIndex);
				currentIndex -= 1;

				// And swap it with the current element.
				temporaryValue = array[currentIndex];
				array[currentIndex] = array[randomIndex];
				array[randomIndex] = temporaryValue;
			}

			return array;
		}

		// picks pictures for experiment
		function getPics(experimentType) {
			let lineup = [];
			if (experimentType.includes("tp")) {
				lineup.push("media/target.jpg");
			}
			while (lineup.length < 6) {
				let pic = "media/fillers/" + Math.floor((Math.random() * 114) + 1) + ".jpg";
				// prevent duplicates by checking if pic is already in lineup
				if (!lineup.includes(pic)) {
					lineup.push(pic);
				}
			}
			return shuffle(lineup);
		}

		function addPics(lineup) {
			for (let pic in lineup) {
				document.getElementById(pic).src = lineup[pic];
			}
		}

		function submit() {
			let slider_values = [];
			let imgs = document.getElementsByTagName("img");
			let index;
			for (let i = 0; i < 6; i++) {
				// get confidence scores from sliders
				slider_values.push(document.getElementById("slider" + i).value);

				/* get index of target picture */
				if (imgs[i].src.includes("media/target.jpg")) {
					index = i;
				}
			}

			console.log("taret%:" + slider_values[index]);
			console.log(slider_values);

			// if (document.getElementById('formSelection').value != "N/A" && document.getElementById('formConfidence').value != "N/A") {
			// 	//check to see if
			// 	if (window.experimentType === "dtnp" || window.experimentType === "ddtnp") {
			// 		if (document.getElementById('formSure').value == 'No') {
			// 			window.correct = true;
			// 		}
			// 	} else {
			// 		if (document.getElementById('formSure').value == 'No') {
			// 			window.correct = false;
			// 		}
			// 	}
			// 	let conf = document.querySelector('#formConfidence');
			// 	let confidence = conf.options[conf.selectedIndex].value;
			// 	let sure = document.querySelector('#formSure');
			// 	let surety = sure.options[sure.selectedIndex].value;
				// const database = firebase.database();
				// let checked = "N/A"
				//
				// database.ref('slider/' + window.userId).update({
				// 	"correct": window.correct,
				// 	"confidence level": confidence,
				// 	"selected filler": window.placeholder,
				// 	"person selected from video": surety,
				// 	"checked 'not present'": (document.getElementById("notPresentCheck").checked) ? "true" : (window.experimentType.slice(2, 3) === "s") ? "false" : "N/A"
				// }).then((response) => {
				// 	redirect();
				// });
			// } else {
			// 	document.getElementById('Next').style.visibility = "hidden";
			// }
		}

		function redirect() {
			window.location.href = '/stimQuestions';
		}
	</script>

</body>

</html>
