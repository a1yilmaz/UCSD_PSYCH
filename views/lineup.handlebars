<html>
<meta charset="utf-8">

<head>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-auth.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-database.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.7.2/firebase-firestore.js"></script>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link href="https://fonts.googleapis.com/css?family=Open+Sans|Roboto" rel="stylesheet">
	<link rel="stylesheet" href="css/styles.css" type="text/css" />
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
</head>

<body>
	<div class="container">
		<div class="row">
			<h5>Please select the person who looks most like the woman in the video. </h5>
		</div>
		<div class="row justify-content-between">
			<div class="col-md-4">
				<img id='0' src='media/fillers/blank.png' onClick='imageClicked(this)'>
			</div>
			<div class="col-md-4">
				<img id='1' src='media/fillers/blank.png' onClick='imageClicked(this)'>
			</div>
			<div class="col-md-4">
				<img id='2' src='media/fillers/blank.png' onClick='imageClicked(this)'>
			</div>
		</div>
		<div class="row justify-content-between mt-4">
			<div class="col-md-4">
				<img id='3' src='media/fillers/blank.png' onClick='imageClicked(this)'>
			</div>
			<div class="col-md-4">
				<img id='4' src='media/fillers/blank.png' onClick='imageClicked(this)'>
			</div>
			<div class="col-md-4">
				<img id='5' src='media/fillers/blank.png' onClick='imageClicked(this)'>
			</div>
		</div>
		<div class="form-group row">
			<div class="form-check mt-3" id="standard" hidden="true">
				<input id="notPresentCheck" class="form-check-input" type="checkbox" onclick="radioClicked(this)" style="width:20px; height: 20px; border-radius: 4px; background-color: lightgrey; " />
				<label class="form-check-label mt-1" style="font-size: 1.25rem; margin-top: 0.4rem">Check here <strong>if the person is not present</strong></label>
			</div>
		</div>
		<div id="present" class="form-group row my-4 d-none">
			<div class="form-inline">
				<label id="textSure" class="col-auto">Is the person you selected actually the woman from the video?</label>
				<select name="formSure" id="formSure" class="form-control col-1" onChange="showConf()">
					<option value="N/A" selected disabled></option>
					<option value="Yes">Yes</option>
					<option value="No">No</option>
				</select>
			</div>
		</div>
		<div id="confidence" class="form-group row my-4 d-none">
			<div class="form-inline">
				<label id="textConfidence" class="col-auto">How certain are you?</label>

				<select name="formConfidence" id="formConfidence" class="form-control col-1" onChange="{document.getElementById('Next').hidden = false}">
					<option value="N/A" selected disabled></option>
					<option value="0">0% (I am guessing)</option>
					<option value="10">10%</option>
					<option value="20">20%</option>
					<option value="30">30%</option>
					<option value="40">40%</option>
					<option value="50">50%</option>
					<option value="60">60%</option>
					<option value="70">70%</option>
					<option value="80">80%</option>
					<option value="90">90%</option>
					<option value="100">100% (I am completely certain)</option>
				</select>
			</div>
		</div>
		<div class="row">
			<input id="Next" onClick="checkInput()" class="btn btn-primary" type="submit" name="formSubmit" value="Next" hidden="true" />
		</div>
	</div>

	<table width="780" cellpadding="10" cellspacing="0" border="0" align="center">
		<tr>
			<td align="center">
				<div>
				</div>
			</td>
			<td align="center">

			</td>
		</tr>
		<tr>
			<td align="center" colspan=2></td>
		</tr>

	</table>

	<select name="formSelection" id="formSelection" onChange="checkInput()" hidden="true" />
	<option value="N/A"></option>
	<option value="Not present">Not present</option>
	<option value="063">1</option>
	<option value="040">2</option>
	<option value="051">3</option>
	<option value="111">4</option>
	<option value="049">5</option>
	<option value="010">6</option>
	</select>


	<select name="formId" id="formId" onChange="checkInput()" style="visibility: hidden" />
	<option value="1"></option>

	<script type="text/javascript">
		var config = {
			apiKey: "AIzaSyCa5_e0vkkiBXQxKcpvGKHyumnWyvQ_os8",
			authDomain: "ucsd-psych.firebaseapp.com",
			databaseURL: "https://ucsd-psych.firebaseio.com",
			projectId: "ucsd-psych",
			storageBucket: "ucsd-psych.appspot.com",
			messagingSenderId: "325328536445"
		};
		firebase.initializeApp(config);

		document.getElementsByTagName("body")[0].onload = function(){
			firebase.auth().onAuthStateChanged(function(user) {
				if (user) {
					window.userId = user.uid;
					firebase.database().ref("original/" + window.userId + "/experiment type")
						.once('value').then(function(snapshot) {
							window.experimentType = snapshot.val();

							if (window.experimentType.includes("s")) {
								document.getElementById('standard').hidden = false;
								//show button
							}

							let lineup = getPics(window.experimentType);

							addPics(lineup);
						});
				} else {
					window.location = '/debrief'
				}
			});
		}

		function shuffle(array) {
			var currentIndex = array.length,
				temporaryValue, randomIndex;

			// While there remain elements to shuffle...
			while (0 !== currentIndex) {

				// Pick a remaining element...
				randomIndex = Math.floor(Math.random() * currentIndex);
				currentIndex -= 1;

				// And swap it with the current element.
				temporaryValue = array[currentIndex];
				array[currentIndex] = array[randomIndex];
				array[randomIndex] = temporaryValue;
			}

			return array;
		}

		function getPics(experimentType) {
			let lineup = [];
			if (experimentType.slice(-2) === "tp") {
				lineup.push("media/target.jpg");
			}
			while (lineup.length < 6) {
				let pic = "media/fillers/" + Math.floor((Math.random() * 114) + 1) + ".jpg";
				// prevent duplicates by checking if pic is already in lineup
				if(!lineup.includes(pic)){
					lineup.push(pic);
				}
			}
			return shuffle(lineup);
		}

		function addPics(lineup) {
			for (let pic in lineup) {
				document.getElementById(pic).src = lineup[pic];
			}
		}

		function checkInput() {
			if (document.getElementById('formSelection').value != "N/A" && document.getElementById('formConfidence').value != "N/A") {
				//check to see if
				if (window.experimentType === "dtnp" || window.experimentType === "ddtnp") {
					if (document.getElementById('formSure').value == 'No') {
						window.correct = true;
					}
				} else {
					if (document.getElementById('formSure').value == 'No') {
						window.correct = false;
					}
				}
				let conf = document.querySelector('#formConfidence');
				let confidence = conf.options[conf.selectedIndex].value;
				let sure = document.querySelector('#formSure');
				let surety = sure.options[sure.selectedIndex].value;
				const database = firebase.database();
				let checked = "N/A"

				database.ref('original/' + window.userId).update({
					"correct": window.correct,
					"confidence level": confidence,
					"selected filler": window.placeholder,
					"person selected from video": surety,
					"checked 'not present'": (document.getElementById("notPresentCheck").checked) ? "true" : (window.experimentType.slice(2, 3) === "s") ? "false" : "N/A"
				}).then((response) => {
					redirect();
				});
			} else {
				document.getElementById('Next').style.visibility = "hidden";
			}
		}

		function imageClicked(id) {
			//makes picture normal sized
			if (document.querySelector(".selected-pic")) {
				document.querySelector(".selected-pic").classList.remove("selected-pic");
			}
			document.getElementById("notPresentCheck").checked = false;
			if (window.experimentType.slice(0, 2) === "dd") {
				for (let i = 0; i < 6; i++) {
					document.getElementById(i).setAttribute("style", "border-color : #FFFFFF");
				}
				id.classList.add("selected-pic");
				id.setAttribute("style", "border-color : #FF0000");
				document.getElementById('formSelection').selectedIndex = 1;
			} else {
				for (let i = 0; i < 6; i++) {
					document.getElementById(i).style.visibility = "hidden";
				}
				document.getElementById('textConfidence').style.visibility = "visible";
				document.getElementById('formConfidence').style.visibility = "visible";
			}

			id.classList.add("selected-pic");
			id.setAttribute("style", "border-color : #FF0000");
			document.getElementById('formSelection').selectedIndex = 1;

			iPhoto = id.id;
			document.getElementById('formSelection').selectedIndex = parseInt(iPhoto) + 1;

			//handles correct choice
			if (id.src.indexOf("media/target.jpg") >= 0) {
				window.placeholder = "false";
				window.correct = "true";
			} else {
				window.placeholder = "true";
				window.correct = "false";
			}
			if (window.experimentType.slice(2, 3) === "s") {
				showConf();
			} else {
				showPresent();
			}

		}

		function radioClicked() {
			for (let i = 0; i < 6; i++) {
				document.getElementById(i).setAttribute("style", "border : none");
			}
			if (window.experimentType.slice(-2) === "tp") {
				window.correct = "false";
			} else {
				window.correct = "true";
			}
			window.placeholder = "false";
			document.getElementById('formSelection').selectedIndex = 1;
			showConf();
		}

		function showConf() {
			document.getElementById('confidence').classList.add("d-block");
		}

		function showPresent() {
			document.getElementById('present').classList.add("d-block");
		}

		function redirect() {
			window.location.href = '/stimQuestions';
		}
	</script>

</body>

</html>
